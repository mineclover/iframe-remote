<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DevTools Parent Example</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }
    h1 { color: #333; }
    .container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }
    .section {
      background: white;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .full-width {
      grid-column: 1 / -1;
    }
    button {
      margin: 5px;
      padding: 10px 20px;
      font-size: 14px;
      cursor: pointer;
      background: #007acc;
      color: white;
      border: none;
      border-radius: 4px;
    }
    button:hover { background: #005a9e; }
    button:disabled { background: #ccc; cursor: not-allowed; }
    input {
      padding: 8px;
      margin: 5px;
      width: 200px;
    }
    iframe {
      width: 100%;
      height: 400px;
      border: 2px solid #ddd;
      border-radius: 4px;
    }
    .functions-list {
      max-height: 300px;
      overflow-y: auto;
      background: #f9f9f9;
      padding: 10px;
      border-radius: 4px;
      margin-top: 10px;
    }
    .function-item {
      padding: 8px;
      margin: 4px 0;
      background: white;
      border: 1px solid #ddd;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .function-item:hover {
      background: #e3f2fd;
      border-color: #007acc;
    }
    .function-item.selected {
      background: #bbdefb;
      border-color: #0066cc;
    }
    .function-name {
      font-weight: bold;
      color: #0066cc;
      font-family: 'Courier New', monospace;
    }
    .function-type {
      color: #666;
      font-size: 12px;
      margin-left: 10px;
    }
    .result {
      margin-top: 15px;
      padding: 15px;
      background: #f9f9f9;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-family: monospace;
      font-size: 12px;
      max-height: 400px;
      overflow-y: auto;
    }
    .result.success {
      background: #e8f5e9;
      border-color: #4caf50;
    }
    .result.error {
      background: #ffebee;
      border-color: #f44336;
      color: #c62828;
    }
    .args-input {
      display: flex;
      gap: 10px;
      margin: 10px 0;
      align-items: center;
    }
  </style>
</head>
<body>
  <h1>üöÄ DevTools Parent - Remote Function Execution</h1>

  <div class="container">
    <div class="section">
      <h3>üìã Available Functions</h3>
      <button id="refresh-btn">üîÑ Refresh List</button>
      <div class="functions-list" id="functions-list">
        <em>Loading...</em>
      </div>
    </div>

    <div class="section">
      <h3>‚ö° Execute Function</h3>
      <div>
        <strong>Selected:</strong> <span id="selected-function">None</span>
      </div>
      <div class="args-input">
        <input type="text" id="args-input" placeholder='Arguments as JSON: [1, "test"]'>
        <button id="execute-btn" disabled>Execute</button>
      </div>
      <div>
        <strong>Quick Execute:</strong><br>
        <button onclick="quickCall('__getUserInfo', [])">getUserInfo()</button>
        <button onclick="quickCall('__getPageData', [])">getPageData()</button>
        <button onclick="quickCall('__add', [5, 3])">add(5, 3)</button>
        <button onclick="quickCall('__getRandomNumber', [1, 100])">getRandomNumber(1, 100)</button>
        <button onclick="quickCall('__asyncOperation', [500])">asyncOperation(500ms)</button>
      </div>
      <div class="result" id="result">
        <em>No execution yet</em>
      </div>
    </div>
  </div>

  <div class="section full-width">
    <h3>üì∫ Child Iframe</h3>
    <iframe id="child-iframe" src="./devtools-child.html"></iframe>
  </div>

  <script type="module">
    import { ParentDevTools } from '../dist/index.js'

    const iframe = document.getElementById('child-iframe')
    const functionsList = document.getElementById('functions-list')
    const selectedFunctionEl = document.getElementById('selected-function')
    const argsInput = document.getElementById('args-input')
    const executeBtn = document.getElementById('execute-btn')
    const resultEl = document.getElementById('result')
    const refreshBtn = document.getElementById('refresh-btn')

    let devtools
    let selectedFunction = null
    let availableFunctions = []

    function showResult(data, isError = false) {
      resultEl.className = `result ${isError ? 'error' : 'success'}`
      resultEl.textContent = JSON.stringify(data, null, 2)
    }

    function showError(error) {
      showResult({
        error: error.message,
        stack: error.stack
      }, true)
    }

    function selectFunction(fn) {
      selectedFunction = fn
      selectedFunctionEl.textContent = fn.name
      executeBtn.disabled = false

      // Update UI
      document.querySelectorAll('.function-item').forEach(item => {
        item.classList.toggle('selected', item.dataset.name === fn.name)
      })
    }

    async function refreshFunctions() {
      try {
        refreshBtn.disabled = true
        refreshBtn.textContent = '‚è≥ Refreshing...'

        availableFunctions = await devtools.refreshFunctions()

        functionsList.innerHTML = ''

        if (availableFunctions.length === 0) {
          functionsList.innerHTML = '<em>No functions found</em>'
          return
        }

        availableFunctions.forEach(fn => {
          const item = document.createElement('div')
          item.className = 'function-item'
          item.dataset.name = fn.name
          item.innerHTML = `
            <span class="function-name">${fn.name}</span>
            <span class="function-type">${fn.type}</span>
          `
          item.addEventListener('click', () => selectFunction(fn))
          functionsList.appendChild(item)
        })

        showResult({ message: `Found ${availableFunctions.length} functions` })
      } catch (error) {
        showError(error)
      } finally {
        refreshBtn.disabled = false
        refreshBtn.textContent = 'üîÑ Refresh List'
      }
    }

    async function executeFunction() {
      if (!selectedFunction) return

      try {
        executeBtn.disabled = true
        executeBtn.textContent = '‚è≥ Executing...'

        let args = []
        const argsStr = argsInput.value.trim()
        if (argsStr) {
          args = JSON.parse(argsStr)
          if (!Array.isArray(args)) {
            throw new Error('Arguments must be an array')
          }
        }

        const result = await devtools.callFunction(selectedFunction.name, ...args)
        showResult({
          function: selectedFunction.name,
          arguments: args,
          result
        })
      } catch (error) {
        showError(error)
      } finally {
        executeBtn.disabled = false
        executeBtn.textContent = 'Execute'
      }
    }

    window.quickCall = async (fnName, args) => {
      try {
        const result = await devtools.callFunction(fnName, ...args)
        showResult({
          function: fnName,
          arguments: args,
          result
        })
      } catch (error) {
        showError(error)
      }
    }

    iframe.addEventListener('load', async () => {
      console.log('‚úÖ Iframe loaded, initializing DevTools...')

      devtools = new ParentDevTools(iframe.contentWindow, {
        targetOrigin: '*'
      })

      // Wait a bit for child to initialize
      await new Promise(resolve => setTimeout(resolve, 100))

      await refreshFunctions()

      console.log('‚úÖ DevTools ready!')
      window.devtools = devtools
    })

    executeBtn.addEventListener('click', executeFunction)
    refreshBtn.addEventListener('click', refreshFunctions)

    argsInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        executeFunction()
      }
    })
  </script>
</body>
</html>
