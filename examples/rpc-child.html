<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RPC Child - Type-Safe Methods</title>
  <style>
    body {
      font-family: 'Monaco', 'Menlo', monospace;
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      min-height: 100vh;
    }
    h1 {
      margin-top: 0;
      border-bottom: 2px solid rgba(255, 255, 255, 0.3);
      padding-bottom: 10px;
    }
    .api-section {
      margin: 20px 0;
      padding: 20px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 8px;
      border-left: 4px solid #4ec9b0;
    }
    .api-section h3 {
      color: #4ec9b0;
      margin-top: 0;
    }
    .status {
      padding: 15px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      margin: 20px 0;
    }
    button {
      margin: 5px;
      padding: 10px 20px;
      font-size: 14px;
      cursor: pointer;
      background: white;
      color: #667eea;
      border: none;
      border-radius: 4px;
      font-family: inherit;
      font-weight: bold;
    }
    button:hover {
      background: #f0f0f0;
    }
    .render-area {
      margin: 20px 0;
      padding: 20px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 8px;
      min-height: 100px;
      border: 2px dashed rgba(255, 255, 255, 0.3);
    }
    .log {
      margin-top: 20px;
      padding: 15px;
      background: rgba(0, 0, 0, 0.4);
      border-radius: 4px;
      max-height: 200px;
      overflow-y: auto;
      font-size: 12px;
    }
    .log-entry {
      padding: 4px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    .log-entry.call {
      color: #66d9ef;
    }
    .log-entry.response {
      color: #a6e22e;
    }
    .type-info {
      color: #9cdcfe;
      font-style: italic;
      font-size: 11px;
    }
  </style>
</head>
<body>
  <h1>üîß RPC Child - Embedded iframe</h1>

  <div class="status">
    <p><strong>Status:</strong> <span id="status">Initializing...</span></p>
    <p><strong>Initialized:</strong> <span id="initialized">false</span></p>
  </div>

  <div class="api-section">
    <h3>üìû Call Parent Methods</h3>
    <div>
      <button id="call-update-config">updateConfig</button>
      <button id="call-request-data">requestData</button>
      <button id="call-notify">notify</button>
    </div>
    <div class="type-info">
      Type: ChildRPC&lt;ParentAPI, ChildAPI&gt;
    </div>
  </div>

  <div class="api-section">
    <h3>üéØ Exposed Child Methods</h3>
    <div class="type-info">
      Parent can call: initialize, getData, render, destroy
    </div>
  </div>

  <div class="render-area" id="render-area">
    <em>Waiting for render() call...</em>
  </div>

  <div class="log">
    <h3>üìã RPC Log</h3>
    <div id="log-content"></div>
  </div>

  <script type="module">
    import { ChildRPC } from '../../dist/rpc.js'

    const statusEl = document.getElementById('status')
    const initializedEl = document.getElementById('initialized')
    const renderArea = document.getElementById('render-area')
    const logContent = document.getElementById('log-content')

    let isInitialized = false
    let childState = {
      status: 'idle',
      items: [],
    }

    function addLog(message, type = 'info') {
      const entry = document.createElement('div')
      entry.className = `log-entry ${type}`
      entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`
      logContent.appendChild(entry)
      logContent.scrollTop = logContent.scrollHeight
    }

    // Create type-safe RPC communicator
    const rpc = new ChildRPC({
      targetOrigin: window.location.origin,
      debug: true,
    })

    // Register methods that parent can call
    rpc.registerAll({
      initialize: async (options) => {
        addLog(`üì• initialize called: ${JSON.stringify(options)}`, 'response')
        isInitialized = true
        initializedEl.textContent = 'true'
        statusEl.textContent = 'Initialized'
        childState.status = 'initialized'

        // Simulate async initialization
        await new Promise(resolve => setTimeout(resolve, 500))
        addLog('‚úÖ Initialization complete', 'response')
      },

      getData: async () => {
        addLog('üì• getData called', 'response')

        if (!isInitialized) {
          throw new Error('Not initialized')
        }

        childState.items.push({
          id: Date.now(),
          value: Math.random(),
        })

        return {
          status: childState.status,
          items: childState.items,
        }
      },

      render: (data) => {
        addLog(`üì• render called: ${JSON.stringify(data)}`, 'response')

        renderArea.innerHTML = `
          <div style="padding: 10px; background: rgba(255,255,255,0.1); border-radius: 4px;">
            <strong>Content:</strong> ${data.content}<br>
            ${data.style ? `<strong>Style:</strong> ${JSON.stringify(data.style)}` : ''}
          </div>
        `

        if (data.style && data.style.color) {
          renderArea.style.borderColor = data.style.color
        }
      },

      destroy: async () => {
        addLog('üì• destroy called', 'response')
        isInitialized = false
        initializedEl.textContent = 'false'
        statusEl.textContent = 'Destroyed'
        childState = { status: 'destroyed', items: [] }

        // Simulate async cleanup
        await new Promise(resolve => setTimeout(resolve, 300))
        addLog('‚úÖ Cleanup complete', 'response')
      },
    })

    addLog('‚úÖ Child RPC ready!', 'info')
    statusEl.textContent = 'Ready'

    // Call parent methods
    document.getElementById('call-update-config').addEventListener('click', async () => {
      addLog('üìû Calling parent.updateConfig...', 'call')
      try {
        await rpc.call('updateConfig', {
          theme: 'dark',
          lang: 'ko',
        })
        addLog('‚úÖ updateConfig completed', 'response')
      } catch (error) {
        addLog(`‚ùå Error: ${error.message}`, 'error')
      }
    })

    document.getElementById('call-request-data').addEventListener('click', async () => {
      addLog('üìû Calling parent.requestData...', 'call')
      try {
        const result = await rpc.call('requestData', 'item-123')
        addLog(`‚úÖ requestData result: ${JSON.stringify(result)}`, 'response')
      } catch (error) {
        addLog(`‚ùå Error: ${error.message}`, 'error')
      }
    })

    document.getElementById('call-notify').addEventListener('click', async () => {
      addLog('üìû Calling parent.notify...', 'call')
      try {
        await rpc.call('notify', 'Hello from child!', 'info')
        addLog('‚úÖ notify completed', 'response')
      } catch (error) {
        addLog(`‚ùå Error: ${error.message}`, 'error')
      }
    })
  </script>
</body>
</html>
